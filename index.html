<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>All Stocks — Dashboard</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#071327; --card:#071927; --muted:#9fb0c7; --text:#e6eef6; --accent:#06b6d4;
    --card-radius:12px; --glass: rgba(255,255,255,0.02);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:linear-gradient(180deg,#061426 0,#071827 100%); color:var(--text); -webkit-font-smoothing:antialiased; min-height:100vh;}
  .wrap{max-width:1200px;margin:26px auto;padding:18px;}
  header{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
  h1{margin:0;font-size:20px}
  p.lead{color:var(--muted);margin:4px 0 16px 0;}
  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:12px}
  input.search{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;min-width:260px;}
  select.filter{padding:9px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;}
  button.btn{padding:9px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;cursor:pointer}
  .table-wrap{background:var(--card);border-radius:var(--card-radius);padding:10px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 30px rgba(3,7,18,0.6)}
  table{width:100%;border-collapse:collapse;font-size:13px}
  thead th{position:sticky;top:0;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));backdrop-filter: blur(2px);padding:10px 8px;text-align:left;z-index:2;border-bottom:1px solid rgba(255,255,255,0.04);cursor:pointer}
  tbody tr{transition:background .12s}
  tbody tr:hover{background:rgba(255,255,255,0.02)}
  td{padding:9px 8px;border-bottom:1px solid rgba(255,255,255,0.02);vertical-align:middle}
  .small{font-size:12px;color:var(--muted)}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--glass);color:var(--muted);font-size:12px}
  .detail{margin-top:14px;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));display:none}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .kpi{padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;flex-direction:column}
  .kpi strong{font-size:16px}
  .muted{color:var(--muted)}
  @media (max-width:880px){
    .grid{grid-template-columns:1fr}
    .controls{flex-direction:column;align-items:stretch}
    input.search{width:100%}
    thead th{font-size:12px}
  }
  .empty{padding:30px;text-align:center;color:var(--muted)}
  .loading{padding:10px;color:var(--muted)}
  .sort-ind{font-size:11px;color:var(--muted);margin-left:6px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>All Stocks</h1>
        <p class="lead">Live table driven by your Google Sheet. Search, sort, filter and click a company to see fundamentals.</p>
      </div>
    </header>

    <div class="controls">
      <input id="searchBox" class="search" placeholder="Search by company name or ticker (type to filter)"/>
      <select id="countryFilter" class="filter" title="Filter by country">
        <option value="">All Countries</option>
      </select>
      <select id="sectorFilter" class="filter" title="Filter by sector">
        <option value="">All Sectors</option>
      </select>
      <button id="resetBtn" class="btn" title="Reset filters">Reset</button>
      <div style="margin-left:auto;color:var(--muted);font-size:13px" id="rowCount">Loading…</div>
    </div>

    <div class="table-wrap" id="tableWrap">
      <div class="loading" id="loading">Loading data from Google Sheets…</div>

      <table id="stocksTable" style="display:none">
        <thead>
          <tr>
            <th data-key="Company Name">Company <span class="sort-ind">↕</span></th>
            <th data-key="Ticker">Ticker</th>
            <th data-key="Current Price">Price</th>
            <th data-key="Market Cap">Market Cap</th>
            <th data-key="P/E">P/E</th>
            <th data-key="Dividend Yield">Div Yield</th>
            <th data-key="EPS">EPS</th>
            <th data-key="Sector">Sector</th>
            <th data-key="Country">Country</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="empty" id="noResults" style="display:none">No companies found.</div>
    </div>

    <div class="detail" id="detailPanel" aria-hidden="true">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h2 id="detailTitle" style="margin:0">Company</h2>
          <div class="small" id="detailTicker">Ticker • Exchange</div>
        </div>
        <div style="text-align:right">
          <div class="small">Last updated: <span id="lastUpdated">—</span></div>
        </div>
      </div>

      <div class="grid" style="margin-top:12px">
        <div class="kpi"><div class="muted">Price</div><strong id="dPrice">—</strong></div>
        <div class="kpi"><div class="muted">Market Cap</div><strong id="dCap">—</strong></div>
        <div class="kpi"><div class="muted">P/E</div><strong id="dPE">—</strong></div>
        <div class="kpi"><div class="muted">Dividend Yield</div><strong id="dDiv">—</strong></div>
        <div class="kpi"><div class="muted">EPS</div><strong id="dEPS">—</strong></div>
        <div class="kpi"><div class="muted">52-Week Range</div><strong id="dRange">—</strong></div>
      </div>

      <div style="margin-top:12px" class="small">
        <strong>Sector:</strong> <span id="dSector">—</span> &nbsp; • &nbsp;
        <strong>Industry:</strong> <span id="dIndustry">—</span> &nbsp; • &nbsp;
        <strong>Country:</strong> <span id="dCountry">—</span>
      </div>
    </div>

  </div>

<script>
(async function(){
  try {
    // ========== CONFIG ==========
    // Your sheet ID (you already gave this): replace only if needed
    const sheetId = '19iDt30lxPe3aU9BzX8Vvk7fhAafuLKKSYoO5d0TKY7c';

    // Option A (fast, works if sheet is shared / published):
    //  - If you published to web as CSV, use the pub link below (uncomment and paste)
    // const csvUrlPublished = 'https://docs.google.com/spreadsheets/d/e/XXXXX/pub?output=csv';

    // Option B (attempt to export CSV directly from sheet ID)
    // This works when sheet is "Anyone with link - Viewer" OR published.
    const gid = 0; // change if your data is on a different tab (check gid in sheet URL)
    const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;

    // ========== CSV parser (handles quoted commas/newlines) ==========
    function parseCSV(text){
      const rows = [];
      let row = [], field = '', inQuotes = false;
      for (let i=0;i<text.length;i++){
        const c = text[i], next = text[i+1];
        if (c === '"') {
          if (inQuotes && next === '"') { field += '"'; i++; continue; } // escaped quote
          inQuotes = !inQuotes;
          continue;
        }
        if (!inQuotes && (c === ',' || c === '\n' || c === '\r')) {
          if (c === ',') { row.push(field); field=''; continue; }
          // newline
          row.push(field); field=''; rows.push(row); row=[];
          if (c === '\r' && next === '\n') { i++; }
          continue;
        }
        field += c;
      }
      // final
      if (field !== '' || row.length) { row.push(field); rows.push(row); }
      return rows;
    }

    // ========== fetch CSV ==========
    const res = await fetch(csvUrl);
    if (!res.ok) {
      // helpful error message with steps
      throw new Error('Failed to fetch CSV. Make sure the sheet is published/shared as "Anyone with link can view" OR publish to web as CSV and use that published URL.');
    }
    const txt = await res.text();
    const raw = parseCSV(txt).filter(r => r.join('').trim() !== '');

    if (!raw.length || raw.length < 2) {
      document.getElementById('loading').innerText = 'No data found in sheet — check that first row is header and sheet has data.';
      return;
    }

    // ========== build objects from headers ==========
    const headers = raw[0].map(h => h.trim());
    const rows = raw.slice(1).map(r => {
      const obj = {};
      for (let i=0;i<headers.length;i++){
        obj[headers[i]] = (r[i] !== undefined) ? r[i].trim() : '';
      }
      return obj;
    });

    // expected headers you told me:
    // Company Name, Ticker, Exchange, Current Price, Market Cap, P/E, 52-Week High, 52-Week Low, Dividend Yield, EPS, Sector, Industry, Country
    // We'll map flexibly (case/space insensitive)
    const headerMap = {};
    headers.forEach(h => {
      const key = h.toLowerCase().replace(/\s+/g,'');
      if (key.includes('company')) headerMap['Company Name'] = h;
      if (key === 'ticker' || key === 'symbol') headerMap['Ticker'] = h;
      if (key.includes('exchange')) headerMap['Exchange'] = h;
      if (key.includes('price')) headerMap['Current Price'] = h;
      if (key.includes('marketcap')) headerMap['Market Cap'] = h;
      if (key === 'pe' || key.includes('p/e')) headerMap['P/E'] = h;
      if (key.includes('52weekhigh') || key.includes('52-weekhigh') || key.includes('52week_high')) headerMap['52-Week High'] = h;
      if (key.includes('52weeklow') || key.includes('52-weeklow') || key.includes('52week_low')) headerMap['52-Week Low'] = h;
      if (key.includes('dividendyield') || key.includes('dividend')) headerMap['Dividend Yield'] = h;
      if (key.includes('eps')) headerMap['EPS'] = h;
      if (key.includes('sector')) headerMap['Sector'] = h;
      if (key.includes('industry')) headerMap['Industry'] = h;
      if (key.includes('country')) headerMap['Country'] = h;
    });

    // fallback if headerMap misses keys (use exact header names)
    const required = ['Company Name','Ticker','Exchange','Current Price','Market Cap','P/E','52-Week High','52-Week Low','Dividend Yield','EPS','Sector','Industry','Country'];
    required.forEach(k => { if (!headerMap[k] && headers.includes(k)) headerMap[k] = k; });

    // create master list
    function fmt(v){ return (v && v.length) ? v : '—'; }
    const master = rows.map(r => {
      return {
        raw: r,
        display: {
          'Company Name': fmt(r[headerMap['Company Name']] || r[headerMap['Ticker']] || ''),
          'Ticker': fmt(r[headerMap['Ticker']]),
          'Exchange': fmt(r[headerMap['Exchange']]),
          'Current Price': fmt(r[headerMap['Current Price']]),
          'Market Cap': fmt(r[headerMap['Market Cap']]),
          'P/E': fmt(r[headerMap['P/E']]),
          'Dividend Yield': fmt(r[headerMap['Dividend Yield']]),
          'EPS': fmt(r[headerMap['EPS']]),
          '52-Week High': fmt(r[headerMap['52-Week High']]),
          '52-Week Low': fmt(r[headerMap['52-Week Low']]),
          'Sector': fmt(r[headerMap['Sector']]),
          'Industry': fmt(r[headerMap['Industry']]),
          'Country': fmt(r[headerMap['Country']])
        }
      };
    });

    // populate country and sector filters
    const countries = new Set(), sectors = new Set();
    master.forEach(m => { if (m.display['Country'] && m.display['Country'] !== '—') countries.add(m.display['Country']); if (m.display['Sector'] && m.display['Sector'] !== '—') sectors.add(m.display['Sector']); });
    const countryFilter = document.getElementById('countryFilter');
    const sectorFilter = document.getElementById('sectorFilter');
    Array.from(countries).sort().forEach(c => { const o=document.createElement('option'); o.value=c; o.textContent=c; countryFilter.appendChild(o); });
    Array.from(sectors).sort().forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; sectorFilter.appendChild(o); });

    // render function
    const tbody = document.querySelector('#stocksTable tbody');
    function render(list){
      tbody.innerHTML = '';
      if (!list.length){ document.getElementById('stocksTable').style.display='none'; document.getElementById('noResults').style.display=''; document.getElementById('rowCount').innerText='0 results'; return; }
      document.getElementById('noResults').style.display='none'; document.getElementById('stocksTable').style.display='';
      list.forEach(item => {
        const d = item.display;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(d['Company Name'])}</td>
          <td class="small">${escapeHtml(d['Ticker'])}</td>
          <td>${escapeHtml(d['Current Price'])}</td>
          <td>${escapeHtml(d['Market Cap'])}</td>
          <td>${escapeHtml(d['P/E'])}</td>
          <td>${escapeHtml(d['Dividend Yield'])}</td>
          <td>${escapeHtml(d['EPS'])}</td>
          <td class="small">${escapeHtml(d['Sector'])}</td>
          <td class="small">${escapeHtml(d['Country'])}</td>
        `;
        tr.addEventListener('click', () => showDetail(item));
        tbody.appendChild(tr);
      });
      document.getElementById('rowCount').innerText = list.length + ' companies';
    }

    // initial render
    render(master);
    document.getElementById('loading').style.display='none';

    // search and filters
    const searchBox = document.getElementById('searchBox');
    function applyFilters(){
      const q = (searchBox.value||'').trim().toLowerCase();
      const country = countryFilter.value;
      const sector = sectorFilter.value;
      const filtered = master.filter(item => {
        const d = item.display;
        const txt = (d['Company Name'] + ' ' + d['Ticker']).toLowerCase();
        if (q && !txt.includes(q)) return false;
        if (country && d['Country'] !== country) return false;
        if (sector && d['Sector'] !== sector) return false;
        return true;
      });
      render(filtered);
    }
    searchBox.addEventListener('input', applyFilters);
    countryFilter.addEventListener('change', applyFilters);
    sectorFilter.addEventListener('change', applyFilters);
    document.getElementById('resetBtn').addEventListener('click', () => { searchBox.value=''; countryFilter.value=''; sectorFilter.value=''; applyFilters(); });

    // sorting
    const headersEls = document.querySelectorAll('thead th');
    let sortKey = null, sortAsc = true;
    headersEls.forEach(h => {
      h.addEventListener('click', () => {
        const key = h.getAttribute('data-key');
        if (sortKey === key) sortAsc = !sortAsc; else { sortKey = key; sortAsc = true; }
        master.sort((a,b) => {
          const Araw = (a.display[key]||'').replace(/[^0-9.\-]/g,'');
          const Braw = (b.display[key]||'').replace(/[^0-9.\-]/g,'');
          const nA = parseFloat(Araw), nB = parseFloat(Braw);
          if (!isNaN(nA) && !isNaN(nB)) return sortAsc ? nA - nB : nB - nA;
          const sA = (a.display[key]||'').toLowerCase();
          const sB = (b.display[key]||'').toLowerCase();
          if (sA < sB) return sortAsc ? -1 : 1;
          if (sA > sB) return sortAsc ? 1 : -1;
          return 0;
        });
        applyFilters();
      });
    });

    // detail panel
    const detail = document.getElementById('detailPanel');
    function showDetail(item){
      const d = item.display;
      document.getElementById('detailTitle').innerText = d['Company Name'];
      const ex = item.raw[headerMap['Exchange']] || '';
      document.getElementById('detailTicker').innerText = (d['Ticker'] || '') + (ex ? (' • ' + ex) : '');
      document.getElementById('dPrice').innerText = d['Current Price'];
      document.getElementById('dCap').innerText = d['Market Cap'];
      document.getElementById('dPE').innerText = d['P/E'];
      document.getElementById('dDiv').innerText = d['Dividend Yield'];
      document.getElementById('dEPS').innerText = d['EPS'];
      document.getElementById('dRange').innerText = (d['52-Week Low'] !== '—' && d['52-Week High'] !== '—') ? (d['52-Week Low'] + ' — ' + d['52-Week High']) : '—';
      document.getElementById('dSector').innerText = d['Sector'];
      document.getElementById('dIndustry').innerText = (item.raw[headerMap['Industry']] || '—');
      document.getElementById('dCountry').innerText = d['Country'];
      document.getElementById('lastUpdated').innerText = new Date().toLocaleString();
      detail.style.display = 'block';
      detail.scrollIntoView({behavior:'smooth', block:'center'});
    }

    // small utility: escape HTML
    function escapeHtml(s){ if (!s) return ''; return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

  } catch (err) {
    console.error(err);
    const loadingEl = document.getElementById('loading');
    loadingEl.innerText = 'Error loading sheet: ' + err.message + '. If you see CORS/403, publish the sheet to web as CSV and replace csvUrl with the published CSV link.';
  }
})();
</script>
</body>
</html>
